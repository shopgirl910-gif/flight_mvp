<!DOCTYPE html>
<html>
<head>
  <!--
    If you are serving your web app in a path other than the root, change the
    href value below to reflect the base path you are serving from.

    The path provided below has to start and end with a slash "/" in order for
    it to work correctly.

    For more details:
    * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

    This is a placeholder for base href that will be replaced by the value of
    the `--base-href` argument provided to `flutter build`.
  -->
  <base href="$FLUTTER_BASE_HREF">

  <meta charset="UTF-8">
  <meta content="IE=Edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="MRP - Mileage Run Planner">

  <!-- iOS meta tags & icons -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="MRP">
  <link rel="apple-touch-icon" href="icons/Icon-192.png">

  <!-- Favicon -->
  <link rel="icon" type="image/png" href="favicon.png"/>

  <!-- ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ¶å¾¡ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">

  <!-- ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆæ›´æ–°æ™‚ã«ã“ã“ã‚’å¤‰æ›´ï¼‰ -->
  <meta name="app-version" content="1.2.2">

  <title>MRP - Mileage Run Planner</title>
  <link rel="manifest" href="manifest.json">

  <style>
    /* PWAã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ */
    .pwa-banner {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #7b1fa2, #9c27b0);
      color: white;
      padding: 12px 16px;
      z-index: 9999;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
      animation: slideUp 0.3s ease-out;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .pwa-banner .banner-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      max-width: 600px;
      margin: 0 auto;
      gap: 12px;
    }
    .pwa-banner .banner-text {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .pwa-banner .banner-icon {
      font-size: 24px;
    }
    .pwa-banner .banner-message {
      font-size: 13px;
      line-height: 1.4;
    }
    .pwa-banner .close-btn {
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 13px;
      background: rgba(255,255,255,0.2);
      color: white;
      flex-shrink: 0;
    }
    .pwa-banner .highlight {
      background: rgba(255,255,255,0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
    }

    /* iOSç”¨èª¬æ˜ãƒãƒŠãƒ¼ */
    #ios-install-banner .ios-steps {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(255,255,255,0.1);
      border-radius: 8px;
      font-size: 13px;
    }
    #ios-install-banner .ios-step {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #ios-install-banner .step-icon {
      font-size: 18px;
    }
    #ios-install-banner .share-icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 4px;
      text-align: center;
      line-height: 20px;
      font-size: 14px;
      color: #7b1fa2;
    }

    /* æ›´æ–°é€šçŸ¥ãƒãƒŠãƒ¼ */
    #update-banner {
      background: linear-gradient(135deg, #1976d2, #2196f3);
    }
    #update-banner .update-btn {
      background: #fff;
      color: #1976d2;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: bold;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <!-- æ›´æ–°é€šçŸ¥ãƒãƒŠãƒ¼ -->
  <div id="update-banner" class="pwa-banner">
    <div class="banner-content">
      <div class="banner-text">
        <span class="banner-icon">ğŸ”„</span>
        <span class="banner-message">
          æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™ï¼<br>
          æ›´æ–°ã—ã¦ãã ã•ã„
        </span>
      </div>
      <button id="update-btn" class="update-btn">æ›´æ–°ã™ã‚‹</button>
      <button id="update-close-btn" class="close-btn">å¾Œã§</button>
    </div>
  </div>

  <!-- PC/Androidç”¨æ¡ˆå†…ãƒãƒŠãƒ¼ -->
  <div id="pwa-install-banner" class="pwa-banner">
    <div class="banner-content">
      <div class="banner-text">
        <span class="banner-icon">âœˆï¸</span>
        <span class="banner-message">
          ã‚¢ãƒ—ãƒªã¨ã—ã¦ä½¿ãˆã¾ã™ï¼<br>
          ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼å³ã® <span class="highlight">âŠ•</span> ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        </span>
      </div>
      <button id="pwa-close-btn" class="close-btn">OK</button>
    </div>
  </div>

  <!-- iOSç”¨èª¬æ˜ãƒãƒŠãƒ¼ -->
  <div id="ios-install-banner" class="pwa-banner">
    <div class="banner-content" style="flex-direction: column; align-items: stretch;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <div class="banner-text">
          <span class="banner-icon">âœˆï¸</span>
          <span class="banner-message">
            MRPã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ 
          </span>
        </div>
        <button id="ios-close-btn" class="close-btn">OK</button>
      </div>
      <div class="ios-steps">
        <div class="ios-step">
          <span class="step-icon">1ï¸âƒ£</span>
          <span>ä¸‹ã® <span class="share-icon">â†‘</span> å…±æœ‰ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—</span>
        </div>
        <div class="ios-step">
          <span class="step-icon">2ï¸âƒ£</span>
          <span>ã€Œãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€ã‚’é¸æŠ</span>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ã‚¢ãƒ—ãƒªãƒãƒ¼ã‚¸ãƒ§ãƒ³
    const APP_VERSION = document.querySelector('meta[name="app-version"]').content;
    const STORED_VERSION_KEY = 'mrp-app-version';

    // ãƒ‡ãƒã‚¤ã‚¹åˆ¤å®š
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isInStandaloneMode = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    const pcBanner = document.getElementById('pwa-install-banner');
    const iosBanner = document.getElementById('ios-install-banner');
    const updateBanner = document.getElementById('update-banner');
    const closeBtn = document.getElementById('pwa-close-btn');
    const iosCloseBtn = document.getElementById('ios-close-btn');
    const updateBtn = document.getElementById('update-btn');
    const updateCloseBtn = document.getElementById('update-close-btn');

    // ãƒãƒŠãƒ¼è¡¨ç¤ºåˆ¤å®šï¼ˆ7æ—¥é–“éè¡¨ç¤ºï¼‰
    function shouldShowBanner(key) {
      const dismissed = localStorage.getItem(key);
      if (dismissed) {
        const dismissedTime = parseInt(dismissed, 10);
        if (Date.now() - dismissedTime < 7 * 24 * 60 * 60 * 1000) {
          return false;
        }
      }
      return true;
    }

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ›´æ–°ãƒã‚§ãƒƒã‚¯
    function checkForUpdate() {
      const storedVersion = localStorage.getItem(STORED_VERSION_KEY);
      if (storedVersion && storedVersion !== APP_VERSION) {
        // æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚ã‚Š
        updateBanner.style.display = 'block';
        return true;
      }
      // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿å­˜
      localStorage.setItem(STORED_VERSION_KEY, APP_VERSION);
      return false;
    }

    // æ›´æ–°ãƒœã‚¿ãƒ³
    updateBtn.addEventListener('click', () => {
      localStorage.setItem(STORED_VERSION_KEY, APP_VERSION);
      // Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å†èª­ã¿è¾¼ã¿
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          registrations.forEach(registration => {
            registration.update();
          });
        });
      }
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰
      if ('caches' in window) {
        caches.keys().then(names => {
          names.forEach(name => caches.delete(name));
        });
      }
      window.location.reload(true);
    });

    // å¾Œã§ãƒœã‚¿ãƒ³
    updateCloseBtn.addEventListener('click', () => {
      updateBanner.style.display = 'none';
    });

    // èµ·å‹•æ™‚ã®å‡¦ç†
    setTimeout(() => {
      // ã¾ãšæ›´æ–°ãƒã‚§ãƒƒã‚¯
      if (checkForUpdate()) {
        return; // æ›´æ–°ãƒãƒŠãƒ¼è¡¨ç¤ºä¸­ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’å‡ºã•ãªã„
      }

      // ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚’è¡¨ç¤ºã—ãªã„
      if (!isInStandaloneMode) {
        if (isIOS) {
          if (shouldShowBanner('ios-banner-dismissed')) {
            iosBanner.style.display = 'block';
          }
        } else {
          if (shouldShowBanner('pwa-banner-dismissed')) {
            pcBanner.style.display = 'block';
          }
        }
      }
    }, 2000);

    // PC/Android é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    closeBtn.addEventListener('click', () => {
      pcBanner.style.display = 'none';
      localStorage.setItem('pwa-banner-dismissed', Date.now().toString());
    });

    // iOS é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
    iosCloseBtn.addEventListener('click', () => {
      iosBanner.style.display = 'none';
      localStorage.setItem('ios-banner-dismissed', Date.now().toString());
    });

    // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãªã‚‰éè¡¨ç¤º
    window.addEventListener('appinstalled', () => {
      pcBanner.style.display = 'none';
      iosBanner.style.display = 'none';
    });

    // Service Workeræ›´æ–°æ¤œçŸ¥
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        // æ–°ã—ã„Service WorkerãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã£ãŸ
        if (!updateBanner.style.display || updateBanner.style.display === 'none') {
          updateBanner.style.display = 'block';
        }
      });
    }
  </script>

  <script src="flutter_bootstrap.js" async></script>
</body>
</html>
