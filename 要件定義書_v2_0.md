# 要件定義書

# **グローバル航空修行アプリ 要件定義書**

**Version:** 2.0 (2025年2月16日更新)

**作成日:** 2024年12月

**対象:** JAL/ANA修行僧 → 将来的にグローバル展開

---

## **変更履歴**

### Version 2.0 (2025/02/16)
- **Pro版機能実装**
  - Stripe決済連携完了（テストモード→本番モード移行準備）
  - Pro版購入画面・購入完了メッセージ実装
  - 残り枠表示機能（20枠以下のみ表示）
  - 料金体系: アーリーバード100円 → 通常480円
  - Pro版限定機能: AIメール解析入力（未実装）
- **新規登録フロー改善（設計）**
  - メール認証+初期パスワード自動発行
  - プロフィール初期設定を登録時に統合
    - 航空会社選択（JAL/ANA/両方）
    - 目標設定（JGC/SFC/ダイヤモンド等）
    - カード種別
    - 現在マイル数
    - 現在FOP/PP
    - 現在ステータス
- **レグ追加UI変更（設計）**
  - 常に一番上の行で新レグ入力
  - 追加押下で既存レグが一つ下にシフト
  - 最新レグが常に視認可能に
- **ランクシステム導入（設計）**
  - 航空会社ステータス風のゲーミフィケーション
  - レベル制（レグ数・FOP累計等で判定）
  - バッジ・称号システム
- **チェックイン許可フロー明確化**
  - GPS 3km圏内判定
  - 搭乗当日のみチェックイン可能
  - チェックイン済みフライトの記録
- **ドメイン・インフラ情報追加**
  - 本番URL: https://mileage-run-planner.web.app
  - Firebase Hosting（無料独自ドメイン使用中）
  - 将来的なドメイン購入先候補: お名前.com / ムームードメイン

### Version 1.4 (2025/02/11)
- **おまかせ最適化機能を実装**
  - DFS（深さ優先探索）によるルート最適化エンジン
  - パターンA: 単純往復（HOME→HUB→HOME ×1〜2）
  - パターンB: ハブ+シャトル（HOME→HUB→SHUTTLE⇄HUB×N→HOME）
  - パターンC: 三角ルート（HOME→A→B→HOME）
  - 結果表示: FOP最多（ランキング）、レグ最多（ランキング）
  - 重複ルート排除（空港経路ベース）
  - アコーディオンUI（3段ネスト対応）
- **ANA国内線時刻表データ投入**
  - 1,058便（HND/CTS/ITM/FUK/OKA等 全路線）
  - schedulesテーブルにインポート完了
- **Supabaseページネーション対応**
  - range-based取得（pageSize=1000）で1000件超のデータ取得に対応
- **FOP/PP計算精度改善**
  - OptimizedFlight.fopをハードコードgetterからfareRate/bonusFop計算フィールドに変更
  - ソートFOPと表示FOPの不一致を解消
  - ANA bonusFopデフォルト値修正（JAL:400→ANA:0）
- **認証機能強化**
  - パスワードリセット機能追加（Supabase resetPasswordForEmail）
  - おまかせ最適化に未ログイン時のログイン画面遷移を追加
- **UX改善**
  - 運賃種別デフォルト値を「なし」に変更（バリデーション追加）
  - 日付ピッカーのモバイル表示改善（ダイアログ縮小）
  - おまかせ最適化のデフォルト日付を1ヶ月後に変更
  - PWAバナーサイズ縮小（v1.3.4）
- **FOP効率最良カテゴリを削除**

### Version 1.3 (2024/12/30)
- **ANA マイル計算ロジックを修正**
  - ゴールド/プレミアム系カード + ステータス保有時: ステータスボーナス + 5%
  - 対象カード: ANAゴールド, ANAプレミアム, SFCゴールド, SFCプレミアム
  - 修正前: max(カードボーナス率, ステータスボーナス率)
  - 修正後: ステータスボーナス率 + 5%（対象カード×ステータス保有時）

### Version 1.2 (2024/12/17)
- **JAL LSP（Life Status Points）計算機能を追加**
  - フライトLSP: 積算率50%以上で5LSP/搭乗
  - ショッピングLSP: 2,000ショッピングマイル = 5LSP
- **JALカードオプションを追加**
  - ツアープレミアム（積算率100%化）
  - ショッピングマイルプレミアム（100円=1マイル）
  - 自動入会判定ロジック
- 計算ロジックの詳細仕様を明記
- 実装済み機能との整合性を確保

### Version 1.1 (2024/12/05)
- Phase 2に位置情報機能（空港チェックイン）を追加
- ODPT API統合の詳細を明記
- データ提供元表示の必須要件を追加
- 時刻表データ戦略を具体化

---

## **1. プロジェクト概要**

### **1.1 プロジェクト名**

**MRP - Mileage Run Planner**

日本語名：「修行僧プランナー」

### **1.2 目的**

航空会社の上級会員ステータス獲得を目指す「修行僧」向けに、フライトポイント計算・記録管理・コミュニティ機能を提供し、効率的な修行計画立案を支援する。

### **1.3 ビジョン**

- **Phase 1（0-4ヶ月）:** 日本市場（JAL/ANA）でMVPローンチ ✅完了
- **Phase 2（5-7ヶ月）:** Pro版展開・機能拡張 🔄進行中
- **Phase 3（8-12ヶ月）:** アメリカ市場（Delta/American/United）展開
- **Phase 4（12-24ヶ月）:** グローバル展開（欧州・アジア主要航空会社）

### **1.4 ターゲットユーザー**

- **プライマリ:** JAL/ANA修行僧（日本）
- **セカンダリ:** 元修行僧の妄想勢（バーチャル修行）
- **将来:** グローバルな航空ファン

---

## **2. 市場分析**

### **2.1 市場規模**

| 市場 | 潜在ユーザー数 | 優先度 |
|------|---------------|--------|
| 日本（JALのみ） | 数千人 | 低 |
| 日本（JAL+ANA） | 1-2万人 | 高 |
| アメリカ | 10万人以上 | 最高 |
| グローバル | 50万人以上 | 将来 |

### **2.2 競合分析**

- **既存の計算ツール:** JAL/ANA公式ツール（1便ずつのみ）
- **個人開発ツール:** 非公式の計算ツール（機能限定）
- **スプレッドシート:** ユーザーが手動管理
- **競合の弱点:**
    - 一括計算不可
    - モバイル対応不足
    - グローバル対応なし
    - コミュニティ機能なし
    - **LSP計算非対応**
    - **AI入力非対応**

### **2.3 差別化要因**

1. **マルチ航空会社対応**（JAL + ANA + 将来US3社）
2. **一括計算・比較機能**
3. **LSP計算対応**（競合なし）
4. **AIメール解析入力**（Pro版限定）
5. **おまかせ最適化**（DFS探索エンジン）
6. **ゲーミフィケーション**（クイズ・ストリーク・ランクシステム）
7. **マルチプラットフォーム**（Web/PWA）
8. **位置情報連携**（空港チェックイン）

---

## **3. 機能要件**

### **3.1 MVPフェーズ（Phase 1: 0-4ヶ月）✅完了**

### **3.1.1 必須機能**

**【認証機能】✅実装済み**

- ユーザー登録（メール/パスワード）
- ログイン/ログアウト
- パスワードリセット（Supabase resetPasswordForEmail）
- 匿名ログイン（未登録ユーザー向け）
- 未ログイン時の機能制限（おまかせ最適化・旅程保存・AIメール入力）

**【プロフィール管理】✅実装済み**

- 基本情報登録
    - 表示名
    - メールアドレス
- JALステータス設定
    - 現在のステータス（なし/クリスタル/サファイア/JGCプレミア/ダイヤモンド）
    - カード種別（詳細は3.1.3参照）
- ANAステータス設定
    - 現在のステータス（なし/ブロンズ/プラチナ/ダイヤモンド）
    - カード種別（詳細は3.1.3参照）

**【ポイント計算機能】✅実装済み**

- フライト情報入力
    - 航空会社選択（JAL/ANA）
    - 出発地/到着地（ドロップダウン）
    - 運賃種別（必須選択）
    - 座席クラス
    - 搭乗日
    - 便名（任意・自動補完対応）
    - **運賃金額（任意入力・空白可）**
- 自動計算
    - JAL: FOP + マイル + **LSP**
    - ANA: PP + マイル
    - ユーザーのステータス・カード種別・オプションを考慮
- 計算結果表示
    - ポイント数（FOP/PP）
    - マイル数
    - **LSP（JALのみ: フライト + ショッピング）**
    - **単価（運賃入力時のみ）**
- 計算結果の保存

**【履歴管理】✅実装済み**

- 計算履歴一覧
    - 日付順/ポイント順/単価順ソート
    - 航空会社フィルター
- 履歴詳細表示・削除
- 簡易統計
    - 合計FOP/PP/LSP
    - 合計マイル
    - 総搭乗回数
    - 総支出額・平均単価

**【エクスポート機能】🔄Phase 2（Pro版）**

- CSV/Excel形式でダウンロード（Pro版限定）

**【クイズ機能（簡易版）】✅実装済み**

- 1日1問出題
- ストリーク表示

---

### **3.1.2 JALカードオプション（実装済み）**

**【JALカード種別】**

| カード種別 | ショッピングマイルP自動入会 |
|-----------|---------------------------|
| JMB会員 | - |
| JALカード普通会員 | × |
| JALカードCLUB-A会員 | × |
| JALカードCLUB-Aゴールド会員 | ✓ |
| JALカードプラチナ会員 | ✓ |
| JALグローバルクラブ会員(日本) | × |
| JALグローバルクラブ会員(海外) | × |
| JALカードNAVI会員 | ✓ |
| JAL CLUB EST 普通会員 | ✓ |
| JAL CLUB EST CLUB-A会員 | ✓ |
| JAL CLUB EST CLUB-A GOLD会員 | ✓ |
| JAL CLUB EST プラチナ会員 | ✓ |

**【JALカードツアープレミアム】**

- チェックボックスでON/OFF
- 効果: 運賃4・運賃5の積算率を100%に変更
- 対象: 包括旅行運賃、スカイメイト等

**【JALカードショッピングマイル・プレミアム】**

- チェックボックスでON/OFF
- 自動入会カードの場合: 強制ON（グレーアウト）
- 効果: ショッピングマイル換算率を200円→100円に変更

---

### **3.1.3 計算ロジック詳細（実装済み）**

**【JAL FOP計算】**

```
1. 座席ボーナス率
   - 普通席: 0%
   - クラスJ: 10%
   - ファーストクラス: 50%

2. 有効積算率（ツアープレミアム適用時）
   - 運賃4, 運賃5 → 100%に変更
   - その他 → 運賃種別の積算率そのまま

3. フライトマイル = round(区間マイル × (有効積算率 + 座席ボーナス率))

4. ステータスボーナス率
   - なし: 0%
   - クリスタル: 55%
   - サファイア: 105%
   - ダイヤモンド: 130%

5. マイルUPボーナス = round(フライトマイル × ステータスボーナス率)

6. 合計マイル = フライトマイル + マイルUPボーナス

7. 搭乗ボーナスFOP
   - 運賃1, 運賃2: 400 FOP
   - 運賃3, 運賃4: 200 FOP
   - 運賃5, 運賃6: 0 FOP

8. FOP = (フライトマイル × 2) + 搭乗ボーナスFOP
```

**【JAL LSP計算】**

```
■ フライトLSP（国内線）
- 条件: マイル積算対象運賃（積算率50%以上）
- 獲得: 1搭乗 = 5 LSP（固定）

■ ショッピングLSP
- 条件: JALカード保有（JMB会員以外）
- 換算: 2,000ショッピングマイル = 5 LSP
- ショッピングマイル計算:
  - プレミアム入会: 100円 = 1マイル
  - 未入会: 200円 = 1マイル

■ 合計LSP = フライトLSP + ショッピングLSP

■ 表示形式: 「フライトLSP + ショッピングLSP」
  例: 「5 + 15」（= 合計20 LSP）
```

**【ANA PP計算】**

```
1. フライトマイル = int(区間マイル × 積算率)

2. カードボーナス率
   - AMCカード: 0%
   - ANAカード一般/学生: 10%
   - ANAカードワイド: 25%
   - ANAカードゴールド: 25%
   - ANAカードプレミアム: 50%
   - SFC一般: 35%
   - SFCゴールド: 40%
   - SFCプレミアム: 50%

3. ステータスボーナス率（基本値）
   - ダイヤモンド(1年目): 115%
   - ダイヤモンド(継続): 125%
   - プラチナ(1年目): 90%
   - プラチナ(継続): 100%
   - ブロンズ(1年目): 40%
   - ブロンズ(継続): 50%

4. 適用ボーナス率の決定
   - ゴールド/プレミアム系カード + ステータス保有時:
     適用ボーナス率 = ステータスボーナス率 + 5%
     ※対象: ANAゴールド, ANAプレミアム, SFCゴールド, SFCプレミアム
   - それ以外:
     適用ボーナス率 = max(カードボーナス率, ステータスボーナス率)

5. マイルUPボーナス = int(フライトマイル × 適用ボーナス率)

6. 合計マイル = フライトマイル + マイルUPボーナス

7. 搭乗ポイント（運賃種別で決定）
   - 運賃1〜3, 運賃5: 400
   - 運賃6: 200
   - その他: 0

8. PP = int((区間マイル × 積算率 × 2) + 搭乗ポイント)
```

---

### **3.1.4 運賃種別マスタ（実装済み）**

**【JAL運賃種別】**

| 運賃番号 | 名称 | 積算率 | 搭乗ボーナスFOP |
|---------|------|--------|----------------|
| 運賃1 | フレックス等 | 100% | 400 |
| 運賃2 | 株主割引 | 75% | 400 |
| 運賃3 | セイバー | 75% | 200 |
| 運賃4 | スペシャルセイバー | 75% | 200 |
| 運賃5 | 包括旅行運賃 | 50% | 0 |
| 運賃6 | スカイメイト等 | 50% | 0 |

**【ANA運賃種別】**

| 運賃番号 | 名称 | 積算率 | 搭乗ポイント |
|---------|------|--------|-------------|
| 運賃1 | プレミアム運賃 | 150% | 400 |
| 運賃2 | プレミアム小児 | 125% | 400 |
| 運賃3 | 片道・往復 | 100% | 400 |
| 運賃4 | ビジネス | 100% | 0 |
| 運賃5 | 特割A | 75% | 400 |
| 運賃6 | 特割B | 75% | 200 |
| 運賃7 | 特割C | 75% | 0 |
| 運賃8 | いっしょにマイル割 | 50% | 0 |
| 運賃9 | プレミアム株主 | 150% | 0 |
| 運賃10 | 普通株主 | 100% | 0 |
| 運賃11 | 特割プラス | 70% | 0 |
| 運賃12 | スマートシニア | 50% | 0 |
| 運賃13 | 個人包括 | 30% | 0 |

---

### **3.1.5 座席クラスマスタ（実装済み）**

**【JAL座席クラス】**

| クラス | 座席ボーナス率 |
|--------|---------------|
| 普通席 | 0% |
| クラスJ | 10% |
| ファーストクラス | 50% |

**【ANA座席クラス】**

| クラス | 備考 |
|--------|------|
| 普通席 | 標準 |
| プレミアムクラス | 運賃種別で積算率変動 |

---

### **3.1.6 画面構成（MVP）**

1. **スプラッシュ画面** ✅実装済み
2. **ログイン/登録画面** ✅実装済み
   - パスワードリセット機能（実装済み）
3. **メイン画面（5タブ構成）** ✅実装済み
    - シミュレート: 計算機能（自由設計 + おまかせ最適化）
    - 修行ログ: 記録管理（修行済み/予定）
    - クイズ: デイリークイズ
    - チェックイン: 空港位置情報チェックイン
    - プロフィール: ステータス/カード設定、Pro版購入
4. **プロフィール画面** ✅実装済み
    - ステータス/カード設定
    - Pro版購入ボタン
    - データ提供元表示

---

### **3.1.7 おまかせ最適化機能（実装済み）**

**【概要】**
出発空港・日付・航空会社・運賃種別を入力するだけで、1日で完結する最適修行ルートをDFS探索で自動生成する。

**【入力パラメータ】**
- 航空会社（JAL/ANA）
- 出発空港（コードシェア含む選択肢あり）
- 搭乗日（デフォルト: 1ヶ月後）
- 運賃種別（必須選択・デフォルトなし）
- コードシェア便含むチェックボックス

**【探索パターン】**
| パターン | 構造 | 例 |
|---------|------|-----|
| A: 単純往復 | HOME→HUB→HOME ×1〜2 | CTS→HND→CTS×2 |
| B: ハブ+シャトル | HOME→HUB→(SHUTTLE⇄HUB)×N→HOME | CTS→HND→AXT⇄HND×3→CTS |
| C: 三角ルート | HOME→A→B→HOME | CTS→HND→ISG→HND→CTS |

**【結果表示（アコーディオン構造）】**
- 🏆 FOP最多: 重複排除後のFOP降順上位3ルート
- ✈️ レグ最多: 重複排除後のFOP降順上位3ルート
- 各ルートは展開して便名・時刻・レグ別FOP表示
- 修行ログへの直接追加ボタン

**【制約条件】**
- 最低乗り継ぎ時間: 30分
- 同日出発・同日帰着
- ページネーション: range-based取得（1000件/ページ）

**【FOP/PP計算】**
- ユーザー選択の運賃種別に基づくfareRate/bonusFopで統一計算
- OptimizedFlight.fopフィールドに計算結果を格納（表示とソートで同一値使用）

**【認証】**
- 未ログイン時は検索不可（ログイン画面に遷移）

---

### **3.2 Pro版フェーズ（Phase 2: 5-7ヶ月）🔄進行中**

### **3.2.1 Pro版機能**

**【決済システム】✅実装済み**

- **決済プラットフォーム:** Stripe（テストモード実装済み）
- **価格設定:**
  - アーリーバード: 100円（期間限定）
  - 通常価格: 480円
  - 買い切り型（月額制なし）
- **購入フロー:**
  1. プロフィール画面の「Pro版を購入」ボタン
  2. Stripe決済画面へ遷移
  3. 決済完了後、user_profilesのis_pro_userフラグ更新
  4. 購入完了メッセージ表示
- **残り枠表示:** ✅実装済み
  - アーリーバード枠: 20枠以下の場合のみ表示
  - 「残り●枠!」の緊急性表示

**【Pro版限定機能】**

| 機能 | 実装状況 | 備考 |
|------|---------|------|
| CSVエクスポート | 🔄設計中 | 修行ログのフルエクスポート |
| AIメール解析入力 | 🔄設計中 | Claude Sonnet 4.5使用 |
| 広告非表示 | 📅将来 | 現在は広告なし |
| 高度な統計分析 | 📅将来 | Phase 3以降 |

**【AIメール解析入力（設計）】**

- **目的:** 航空券予約確認メールから自動でフライト情報抽出
- **対応航空会社:** JAL/ANA
- **入力方法:**
  - メール本文をペースト
  - または転送メールアドレス提供（Phase 3）
- **抽出項目:**
  - 便名
  - 出発地/到着地
  - 搭乗日
  - 搭乗時刻
  - 運賃種別（推定）
- **AI処理:** Claude Sonnet 4.5 API
- **制限:** Pro版ユーザーのみ利用可能

---

### **3.2.2 新規登録フロー改善（設計）**

**【現状の問題点】**
- 登録後、プロフィール画面で個別設定が必要
- 初回利用時の設定項目が多く離脱リスク
- ステータス・カード・マイル等の初期値が未設定

**【改善後のフロー】**

1. **メール認証**
   - ユーザーがメールアドレスを入力
   - Supabaseが確認メールを送信
   - メール内のリンクをクリックして認証完了
   - **初期パスワード自動発行**（ランダム12桁）
   - 初回ログイン後、パスワード変更を促す

2. **プロフィール初期設定（認証直後）**
   - **航空会社選択**
     - JAL専門
     - ANA専門
     - 両方（デフォルト）
   - **目標設定**
     - JAL: JGC/サファイア/ダイヤモンド/LSP1000
     - ANA: SFC/プラチナ/ダイヤモンド
   - **カード種別**
     - JAL: JMB会員〜JALプラチナまで選択肢
     - ANA: AMCカード〜SFCプレミアムまで選択肢
   - **現在のマイル数**（任意入力）
   - **現在のFOP/PP**（任意入力）
   - **現在のステータス**（なし/クリスタル/サファイア等）

3. **ウェルカム画面**
   - 設定内容の確認
   - チュートリアル動画（オプション）
   - 「修行を始める」ボタンでメイン画面へ

**【技術実装】**
- Supabase Auth（メール認証）
- user_profilesテーブルに初期データINSERT
- onboarding_completedフラグで初回設定済み判定

---

### **3.2.3 レグ追加UI変更（設計）**

**【現状の問題点】**
- レグを追加すると一番下に追加される
- 複数レグ追加時、最新レグを見るためにスクロールが必要
- 時系列順で入力したい修行僧には不便

**【改善後のUI】**

```
┌───────────────────────────────────┐
│ 【新レグ入力欄】               │ ← 常に最上部に固定
│ 出発地: [HND ▼] 到着地: [CTS ▼] │
│ 便名: [JAL501] 日付: [2025/03/15]│
│           [追加] ボタン           │
├───────────────────────────────────┤
│ レグ1: HND→CTS JAL501 (新)       │ ← 追加押下で既存レグが下にシフト
│ レグ2: CTS→HND JAL502            │
│ レグ3: HND→OKA JAL901            │
│ レグ4: OKA→HND JAL902            │
└───────────────────────────────────┘
```

**【実装方針】**
- FlutterのListView.builderで逆順表示
- 追加ボタン押下でリストの先頭にINSERT
- スクロール位置を最上部に自動調整

---

### **3.2.4 ランクシステム（設計）**

**【概要】**
航空会社ステータス風のゲーミフィケーション。ユーザーの活動量に応じてランクアップし、バッジ・称号を獲得。

**【ランク一覧】**

| ランク | 条件 | バッジ | 称号 |
|--------|------|--------|------|
| 見習い修行僧 | 登録直後 | 🛫 | Trainee |
| 修行僧 | 累計10レグ | ✈️ | Practitioner |
| 熟練修行僧 | 累計50レグ | 🛩️ | Expert |
| 師範代 | 累計100レグ | 🚁 | Master |
| 伝説の修行僧 | 累計500レグ | 🛸 | Legend |

**【追加判定要素（Phase 3）】**
- 累計FOP/PP（JAL: 50,000/100,000/300,000、ANA: 50,000/100,000/300,000）
- ストリーク日数（7日/30日/100日連続）
- クイズ正解率（80%以上/90%以上）
- おまかせ最適化利用回数
- Pro版購入者専用ランク

**【表示箇所】**
- プロフィール画面（大きく表示）
- 修行ログ画面（ヘッダー）
- メイン画面タブバー上部（小さく）

---

### **3.2.5 チェックイン許可フロー明確化**

**【GPS判定】**
- **許可範囲:** 空港から半径3km以内
- **位置情報取得:** Geolocator package
- **精度:** 50m以内（GPS高精度モード）

**【時間制約】**
- **当日のみチェックイン可能**
  - 搭乗日の0:00〜23:59（JST）
  - それ以外の日はチェックインボタン非活性

**【チェックイン記録】**
- airport_checkinsテーブルに記録
- フィールド:
  - user_id
  - airport_code（例: HND）
  - checked_in_at（タイムスタンプ）
  - latitude/longitude（チェックイン位置）
  - flight_id（関連フライト、任意）

**【UI表示】**
- チェックイン済み空港: ✅マーク
- 未チェックイン空港: グレーアウト
- GPS圏外: 「この空港に近づいてください」メッセージ

---

### **3.2.6 その他Phase 2機能**

**【実装済み】**
- ✅ おまかせ最適化（DFS探索）
- ✅ 旅程保存（修行ログ）
- ✅ 空港チェックイン（GPS 3km圏内）
- ✅ パスワードリセット
- ✅ PWA対応
- ✅ 多言語対応（日本語/英語）

**【設計中】**
- 🔄 Pro版機能（AIメール解析、CSVエクスポート）
- 🔄 新規登録フロー改善
- 🔄 レグ追加UI変更
- 🔄 ランクシステム

**【未実装（Phase 3以降）】**
- 📅 ODPT API統合（リアルタイム時刻表更新）
- 📅 ソーシャル機能（ユーザーおすすめルート共有・人気度/変態度格付け）
- 📅 日本地図ウィジェット（Paint it Black風）
- 📅 ANA自動座席クラス判定（運賃種別から推定）

---

### **3.3 グローバル展開フェーズ（Phase 3: 8-12ヶ月）**

- アメリカ市場対応（Delta/American/United）
- マイレージプログラム計算ロジック追加
- 多通貨対応（USD/EUR/JPY）
- 海外航空券予約サイトアフィリエイト

---

## **4. 非機能要件**

### **4.1 パフォーマンス**

- ページ読み込み時間: 3秒以内
- 計算処理時間: 1秒以内（単一レグ）
- おまかせ最適化: 10秒以内（通常）、30秒以内（最大）

### **4.2 セキュリティ**

- Supabase RLS（Row Level Security）有効化
- HTTPS通信必須
- パスワード: 8文字以上、英数字混在
- 決済情報: Stripe経由（PCI DSS準拠）

### **4.3 可用性**

- 稼働率: 99.5%以上（Firebase Hosting SLA）
- バックアップ: Supabase自動バックアップ（日次）

### **4.4 スケーラビリティ**

- 同時接続ユーザー: 10,000人対応
- データベース: 100万レコード対応

---

## **5. 技術スタック**

### **5.1 フロントエンド**

- **フレームワーク:** Flutter 3.x
- **言語:** Dart
- **状態管理:** StatefulWidget（MVP）
- **UIライブラリ:** Material Design
- **PWA:** flutter_pwa_wrapper

### **5.2 バックエンド**

- **BaaS:** Supabase
    - データベース: PostgreSQL
    - 認証: Supabase Auth
    - ストレージ: Supabase Storage（将来）
- **決済:** Stripe（テストモード→本番モード）
- **AI:** Claude Sonnet 4.5 API（Anthropic）

### **5.3 ホスティング・ドメイン**

- **ホスティング:** Firebase Hosting
- **本番URL:** https://mileage-run-planner.web.app
- **独自ドメイン（将来）:**
  - 購入先候補: お名前.com / ムームードメイン
  - ドメイン案: mileage-planner.jp / mrp-app.com

### **5.4 開発環境**

- **IDE:** Visual Studio Code
- **バージョン管理:** Git / GitHub
- **CI/CD:** Firebase Hosting（手動デプロイ）
- **環境:**
  - 自宅: Flutter開発メイン
  - 学校: データベース作業・要件定義

---

## **6. データベース設計（概要）**

### **6.1 主要テーブル**

**【マスタテーブル】**

- **airlines（航空会社）**
  - id, code（例: JAL/ANA）, name_ja, name_en
- **airports（空港）**
  - id, code（例: HND）, name_ja, name_en, latitude, longitude, prefecture
- **routes（路線）**
  - id, origin, destination, distance_km
- **schedules（時刻表）**
  - id, airline_code, flight_number, origin, destination, departure_time, arrival_time, operating_days, is_codeshare
  - JAL: 5,100+便（J-AIR/HAC含む）
  - ANA: 1,058便（全国内線路線）
  - ページネーション対応（range-based, 1000件/ページ）

**【ユーザーデータ】**

- **user_profiles（基本情報）**
  - id, email, display_name, created_at, onboarding_completed
  - jal_status, jal_card_type, jal_tour_premium, jal_shopping_premium
  - ana_status, ana_card_type
  - **is_pro_user（Pro版フラグ）**, pro_purchased_at, **pro_expires_at（有効期限）**, **pro_purchase_price（購入時価格）**
  - **current_rank（ランクシステム）**, total_legs, total_fop, total_pp
- **flight_calculations（計算履歴）**
  - id, user_id, airline, origin, destination, flight_date, fare_type, seat_class
  - calculated_fop, calculated_pp, calculated_miles, **calculated_lsp**, fare_amount, created_at
- **saved_itineraries（保存旅程）**
  - id, user_id, itinerary_name, legs（JSON）, total_fop, total_pp, status（予定/修行済み）
- **airport_checkins（空港チェックイン履歴）**
  - id, user_id, airport_code, checked_in_at, latitude, longitude, flight_id

**【クイズ】**

- **quizzes（問題）**
  - id, question_text, correct_answer, options（JSON）, difficulty, created_at
- **user_quiz_answers（回答履歴）**
  - id, user_id, quiz_id, user_answer, is_correct, answered_at
- **quiz_streaks（ストリーク管理）**
  - id, user_id, current_streak, longest_streak, last_answered_at

**【Pro版管理】**

- **pro_purchases（購入履歴）**
  - id, user_id, stripe_payment_id, amount, currency, purchased_at

---

## **7. 実装状況サマリー**

### **Phase 1 実装完了機能** ✅

| 機能 | JAL | ANA | 備考 |
|------|-----|-----|------|
| FOP/PP計算 | ✓ | ✓ | |
| マイル計算 | ✓ | ✓ | |
| LSP計算（フライト） | ✓ | - | 5LSP/搭乗 |
| LSP計算（ショッピング） | ✓ | - | 2000マイル=5LSP |
| ツアープレミアム | ✓ | - | |
| ショッピングマイルP | ✓ | - | 自動入会判定対応 |
| カード種別選択 | ✓ | ✓ | |
| ステータス選択 | ✓ | ✓ | |
| 複数レグ計算 | ✓ | ✓ | |
| 単価表示 | ✓ | ✓ | |
| 便名自動補完 | ✓ | ✓ | 時刻表DB連携 |
| 時刻表データ | ✓ | ✓ | JAL:5100+便, ANA:1058便 |
| おまかせ最適化 | ✓ | ✓ | DFS探索・アコーディオンUI |
| 旅程保存（修行ログ） | ✓ | ✓ | 修行済み/予定タブ |
| 空港チェックイン | ✓ | ✓ | 3km圏内GPS判定 |
| クイズ（デイリー） | ✓ | ✓ | ストリーク対応 |
| パスワードリセット | ✓ | ✓ | Supabase Auth |
| PWA対応 | ✓ | ✓ | v1.3.4 |
| 多言語対応 | ✓ | ✓ | 日本語/英語 |

### **Phase 2 実装済み（Pro版）** ✅

| 機能 | 実装状況 | 備考 |
|------|---------|------|
| Stripe決済連携 | ✓ | テストモード |
| Pro版購入画面 | ✓ | プロフィール画面 |
| 購入完了メッセージ | ✓ | |
| 残り枠表示 | ✓ | 20枠以下のみ |
| is_pro_userフラグ | ✓ | user_profilesテーブル |

### **Phase 2 設計中** 🔄

| 機能 | 優先度 | 備考 |
|------|--------|------|
| AIメール解析入力 | 高 | Claude Sonnet 4.5 |
| CSVエクスポート | 中 | Pro版限定 |
| 新規登録フロー改善 | 高 | メール認証+プロフィール初期設定 |
| レグ追加UI変更 | 中 | 最上部入力方式 |
| ランクシステム | 低 | ゲーミフィケーション |
| 特商法ページ実装 | 高 | Pro版販売に法的必須 |

### **Phase 3以降（未実装）** 📅

- ODPT API統合（リアルタイム時刻表更新）
- ソーシャル機能（ユーザーおすすめルート共有・人気度/変態度格付け）
- 日本地図ウィジェット（Paint it Black風）
- ANA自動座席クラス判定（運賃種別から推定）
- アメリカ市場対応（Delta/American/United）

---

## **8. マネタイゼーション戦略**

### **8.1 Pro版（1年有効期限・段階的値上げ制）**

**【価格戦略】**
- **有効期限:** 購入日から1年間
- **自動更新:** なし（手動更新のみ）
- **価格保証:** 再加入時は初回購入価格で更新可能
  - 例: 100円で購入 → 1年後の更新も100円
  - 例: 200円で購入 → 1年後の更新も200円
- **価格変動:** 加入状況により段階的に値上げ
  - 第1段階: 100円/年
  - 第2段階: 150円または200円/年（柔軟に決定）
  - 以降も段階的に値上げ

**【値上げルール】**
- 値上げ時期は加入状況により柔軟に決定（固定スケジュールなし）
- 値上げ1ヶ月前から告知（X投稿で購入意欲を後押し）
- 次回価格は非公開（柔軟性を保つ）
- 先着枠数は非公開（内部目標のみ、状況により調整可能）

**【有効期限管理】**
- Supabaseの`user_profiles`テーブルで管理
  - `pro_expires_at`: 有効期限（TIMESTAMP）
  - `pro_purchase_price`: 購入時価格（INTEGER）
- ログイン時に自動チェック
  - 期限切れ → `is_pro_user = false`に自動変更
  - 期限7日前 → メール通知 + アプリ内通知
- 更新時は`pro_purchase_price`で再決済

**【ユーザー体験】**
- アプリ内で現在価格・有効期限を表示
- 期限切れ前の通知: メール + プッシュ通知
- 更新ボタン: 購入時価格で再決済
- 自動更新なしを明記（心理的ハードル低減）

**【告知例（X投稿）】**
```
【期間限定】Pro版100円/年
有効期限1年・自動更新なし

一度購入すれば、更新も100円のまま。
近日値上げ予定。

https://mrunplanner.com/pro
#JAL修行僧 #ANA修行僧
```

**【コスト試算】**
- AIメール解析: 約0.6円/回（Claude Sonnet 4.5）
- 月5回制限想定: 年間36円
- 100円/年販売時の粗利: 64円（64%）
- インフラコスト: 約50円/年/ユーザー（Supabase/Firebase）

**【LTV（顧客生涯価値）試算】**
- 初回購入: 100円
- 2年目更新率: 30%想定 → 30円
- 3年目更新率: 20%想定 → 6円
- LTV: 約136円（3年想定）

### **8.2 アフィリエイト（Phase 3以降）**

- **対象:** クレジットカード（JALカード/ANAカード）
- **プラットフォーム:** A8.net / バリューコマース
- **期待収益:** 成約1件あたり5,000〜15,000円

### **8.3 広告（Phase 4以降）**

- **Google AdSense:** 無料版ユーザー向け（Pro版は広告なし）

---

## **9. リリーススケジュール**

### **Phase 1（完了）** ✅

- MVP機能実装
- JAL/ANA計算ロジック完成
- おまかせ最適化リリース
- 空港チェックイン実装

### **Phase 2（現在）** 🔄

| タスク | 期限 | 担当 |
|--------|------|------|
| Stripe本番キー切替 | 2月末 | 自宅でデプロイ |
| AIメール解析実装 | 3月中旬 | Claude API連携 |
| 新規登録フロー改善 | 3月末 | Supabase Auth |
| レグ追加UI変更 | 3月末 | Flutter UI修正 |
| ランクシステム実装 | 4月中旬 | ゲーミフィケーション |

### **Phase 3（8-12ヶ月後）** 📅

- アメリカ市場対応
- アフィリエイト本格稼働
- ソーシャル機能リリース

---

## **10. 付録**

### **10.1 用語集**

| 用語 | 説明 |
|------|------|
| 修行僧 | 航空会社の上級会員ステータス獲得のために頻繁に搭乗する人 |
| FOP | FLY ON ポイント（JAL） |
| PP | プレミアムポイント（ANA） |
| **LSP** | **Life Status Points（JAL生涯ステータス用ポイント）** |
| SFC | スーパーフライヤーズカード（ANA上級会員カード） |
| JGC | JALグローバルクラブ（JAL上級会員） |
| ツアープレミアム | JALカードオプション。包括旅行運賃の積算率を100%にする |
| ショッピングマイルP | JALカードショッピングマイル・プレミアム。100円=1マイルに |
| おまかせ最適化 | DFS探索による1日完結の最適修行ルート自動生成機能 |
| DFS | 深さ優先探索。全ルートパターンを網羅的に探索するアルゴリズム |
| Pro版 | 有料サブスクリプション（AIメール解析、CSVエクスポート等） |

### **10.2 参考資料**

- JAL公式サイト: https://www.jal.co.jp/
- ANA公式サイト: https://www.ana.co.jp/
- JAL LSP説明: https://www.jal.co.jp/jp/ja/jalmile/lsp/
- 本番アプリ: https://mileage-run-planner.web.app
- Stripe公式ドキュメント: https://stripe.com/docs
- Claude API: https://docs.anthropic.com/

### **10.3 ドメイン・インフラ情報**

**【現在の構成】**
- ホスティング: Firebase Hosting（無料枠）
- URL: https://mileage-run-planner.web.app
- SSL証明書: Firebase自動発行

**【将来的な独自ドメイン】**
- 購入先候補:
  - お名前.com（国内最大手、.jp/.comドメイン）
  - ムームードメイン（ロリポップ系、UI分かりやすい）
  - Google Domains（2023年Squarespaceに売却）
- ドメイン候補案:
  - mileage-planner.jp（年間3,000円程度）
  - mrp-app.com（年間1,500円程度）
  - shugyoapp.jp（年間3,000円程度）
- Firebase Hostingカスタムドメイン設定手順:
  1. ドメイン購入
  2. Firebase Hosting > カスタムドメイン追加
  3. DNS設定（Aレコード/CNAMEレコード）
  4. SSL証明書自動発行（Let's Encrypt）

### **10.4 特定商取引法に基づく表記**

**Pro版販売に必須の法的記載事項**

**【販売業者】**
- 販売業者名: [個人事業主名 or 屋号]
- 運営責任者: [氏名]
- 所在地: [住所]（リクエストにより遅滞なく開示）
- 連絡先メールアドレス: [support@mileage-run-planner.web.app]
- 電話番号: [電話番号]（電話での受付は行っておりません）
- お問い合わせ対応時間: メールでのお問い合わせは24時間受付、返信は営業日48時間以内

**【販売価格】**
- アーリーバード価格: 100円（税込）
- 通常価格: 480円（税込）
- ※買い切り型（月額課金なし）

**【支払方法】**
- クレジットカード決済（Stripe経由）
- 対応カード: Visa, Mastercard, American Express, JCB

**【商品の引渡時期】**
- 決済完了後、即時Pro版機能が有効化されます
- システムメンテナンス時は最大24時間以内

**【返品・キャンセルポリシー】**
- デジタルコンテンツの性質上、原則として返金・返品は受け付けておりません
- ただし、以下の場合は返金対応いたします:
  1. 決済エラーにより二重課金が発生した場合
  2. システム不具合により正常にサービスが利用できない場合
  3. その他、当方の責に帰すべき事由がある場合
- 返金申請期限: 購入日から7日以内
- 返金方法: Stripe経由で元の決済手段に返金

**【動作環境】**
- 対応ブラウザ: Google Chrome, Safari, Firefox, Edge（最新版推奨）
- 対応OS: Windows 10以降, macOS 10.15以降, iOS 14以降, Android 8以降
- インターネット接続必須

**【その他】**
- プライバシーポリシー: [別途Webサイトに掲載]
- 利用規約: [別途Webサイトに掲載]
- Supabaseデータベース利用規約に準拠
- Stripe利用規約に準拠

**【表示場所】**
- アプリ内: プロフィール画面下部「特定商取引法に基づく表記」リンク
- Webサイト: フッター部分

**【実装TODO】**
- [ ] 特商法ページのHTMLファイル作成
- [ ] プロフィール画面にリンク追加
- [ ] プライバシーポリシー・利用規約の作成
- [ ] 正式な住所・連絡先の決定（開業届提出後）

---

**文書改訂履歴**

- Version 2.0（2025年2月16日）: Pro版実装、新規登録フロー改善、ランクシステム、ドメイン情報追加
- Version 1.4（2025年2月11日）: おまかせ最適化、ANA時刻表、パスワードリセット、FOP計算統一
- Version 1.3（2024年12月30日）: ANAマイル計算ロジック修正
- Version 1.2（2024年12月17日）: LSP計算機能、JALカードオプションを追加
- Version 1.1（2024年12月5日）: 位置情報機能、ODPT統合、データ戦略を追加
- Version 1.0（2024年12月）: 初版作成
